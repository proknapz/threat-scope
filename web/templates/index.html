<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PHP Vulnerability Scanner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #000; color: white; font-family: monospace; margin:0; padding:0; }

/* Upload box */
@keyframes pulse-glow {
  0%,100% { box-shadow:0 0 8px 2px rgba(119,123,179,0.14); }
  50% { box-shadow:0 0 12px 3px rgba(136,146,190,0.18); }
}
.hover-pulse:hover { animation:pulse-glow 4s infinite; }

.btn { background-color: #8892BE; color: black; padding:0.5rem 1rem; border-radius:0.25rem; cursor:pointer; transition: all 0.2s; }
.btn:hover { background-color:#777BB3; transform: translateY(-1px); }
input[type="file"] { display:none; }

/* Results container */
#resultsContent {
  max-height: 500px;
  overflow-y: auto;
  background-color: #0f0f10;
  padding:0.5rem 1rem;
  border-radius:0.5rem;
  font-family: monospace;
  margin-top:1rem;
  font-size:0.85rem;
  line-height: 1.2rem;
}

/* Code line container */
.code-line {
  display: block;
  margin: 0;
  padding: 0;
}

.code-line:hover {
  background-color: rgba(136,146,190,0.05);
}

/* Line number and code */
.line-number { 
  color:#666; 
  width:3ch; 
  display:inline-block; 
  text-align:right; 
  user-select:none;
  margin-right: 0.5rem;
}
.code { 
  display:inline; 
  white-space: pre;
}
.safe { color:#8892BE; }
.unsafe { color:#b37795; cursor:pointer; }
.unsafe:hover { background-color: rgba(179, 119, 149, 0.2); }

/* Comment lines that can jump to code */
.comment-line {
  color: #7a8a9e;
  cursor: pointer;
}
.comment-line:hover {
  color: #8892BE;
  text-decoration: underline;
}

/* Reports - display on new line */
.reports { 
  font-size:0.7rem; 
  color:#f4c542; 
  display:none; 
  margin-left:4ch;
  padding: 0.15rem 0 0.15rem 0.5rem;
  line-height:1.1rem;
  background-color: rgba(244, 197, 66, 0.05);
  border-left: 2px solid rgba(244, 197, 66, 0.3);
}
.report { 
  display: block;
  margin: 0;
  padding: 0;
}
.cursor-pointer { cursor:pointer; }

.tab-btn.active {
  background-color: rgba(136,146,190,0.15);
  border-radius: 0.25rem;
}

</style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-6">

<h1 class="text-3xl font-bold mb-4 text-[#8892BE] text-center">PHP Vulnerability Scanner</h1>
<!-- NAVIGATION PANEL -->
<div class="w-full max-w-2xl mb-4">
  <div class="flex border-b border-gray-700">
    <button class="tab-btn font-bold text-[#8892BE] px-4 py-2" data-tab="uploadTab">Upload</button>
    <button class="tab-btn text-gray-400 px-4 py-2" data-tab="historyTab">Past Scans</button>
    <a href="/database" class="tab-btn text-gray-400 px-4 py-2 hover:text-[#8892BE]">Database</a>
  </div>

 
  <div id="uploadTab" class="tab-content">
     
  </div>
    <div id="historyTab" class="tab-content hidden">
      {% if past_scans %}
        <div class="space-y-2">
          {% for scan in past_scans %}
            <div class="bg-[#0f0f10] p-3 rounded border border-gray-700 hover:border-[#8892BE] transition-colors">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <a href="{{ url_for('view_scan', scan_id=scan.id) }}" class="text-[#8892BE] hover:underline font-medium">
                    {{ scan.filename }}
                  </a>
                  <div class="text-sm text-gray-400 mt-1">
                    {{ scan.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    {% if scan.total_lines > 0 %}
                      {% set rate = (scan.unsafe_lines / scan.total_lines * 100) %}
                      {{ scan.total_lines }} lines | {{ scan.unsafe_lines }} unsafe | 
                      <span class="{% if rate > 50 %}text-red-400{% elif rate > 20 %}text-yellow-400{% else %}text-green-400{% endif %}">
                        {{ "%.1f"|format(rate) }}% vulnerability rate
                      </span>
                    {% endif %}
                  </div>
                  {% if scan.unsafe_lines > 0 %}
                  <div class="mt-2">
                    <button onclick="generateMitigation({{ scan.id }})" class="text-xs bg-[#8892BE] text-black px-2 py-1 rounded hover:bg-[#777BB3] transition-colors">
                      🔧 Generate Fixes
                    </button>
                  </div>
                  {% endif %}
                </div>
                <div class="text-xs text-gray-500">
                  {{ "%.1f"|format(scan.file_size / 1024) }} KB
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-gray-400 mt-2">No past scans yet.</p>
      {% endif %}
    </div>
</div>

<form id="uploadForm" method="post" enctype="multipart/form-data" class="w-full max-w-2xl">
  <label class="relative w-full h-64 border-4 border-dashed border-[#777BB3] rounded-xl flex items-center justify-center cursor-pointer hover:border-[#8892BE] hover:bg-[#0f0f10] hover-pulse">
    <input type="file" name="file" accept=".php" required>
    <div class="flex flex-col items-center justify-center pointer-events-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-[#777BB3] mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v8m0 0l-4-4m4 4l4-4M12 4v8"/>
      </svg>
      <div class="text-center pointer-events-none">
        <div class="text-[#8892BE] text-lg mb-3">Drag a PHP file here</div>
        <div class="pointer-events-auto">
          <button type="button" onclick="this.closest('label').querySelector('input').click()" class="btn">Browse</button>
        </div>
      </div>
    </div>
  </label>
  <div class="mt-4">
    <button type="submit" class="w-full btn">Scan</button>
  </div>
  <div id="selectedFileName" class="mt-2 text-[#8892BE] text-center"></div>
</form>

{% if results %}
<h2 class="text-2xl font-bold mt-6 mb-2 text-[#8892BE]">Scan Results for {{ filename }}</h2>
<div id="resultsContent">
{% for r in results %}
<div class="code-line" id="line-{{ r.line_num }}">
  {% set stripped_line = r.line.strip() %}
  {% set is_comment = stripped_line.startswith('//') or stripped_line.startswith('/*') or (stripped_line.startswith('*') and not stripped_line.startswith('*/')) or stripped_line == '/*' or stripped_line.startswith('#') %}
  {% set is_descriptive = 'Uses a' in r.line or 'Input :' in r.line or 'SANITIZE :' in r.line or 'construction :' in r.line or 'execute a' in r.line or 'Flushes content' in r.line %}
  
  {% if is_comment or is_descriptive %}
    <span class="comment-line" onclick="jumpToRelatedCode({{ r.line_num }}, '{{ r.line|e }}')" data-line="{{ r.line_num }}">
      <span class="line-number">{{ r.line_num }}</span>
      <span class="code {{ r.label }}">{{ r.line }}</span>
    </span>
  {% else %}
    <span class="cursor-pointer {{ r.label }}" onclick="toggleDetails(this)" data-line="{{ r.line_num }}">
      <span class="line-number">{{ r.line_num }}</span>
      <span class="code {{ r.label }}">{{ r.line }}</span>
    </span>
    {% if r.reports %}
    <div class="reports">
      {% for rep in r.reports %}
      <div class="report">🔸 <strong>{{ rep[0] }}</strong> - tainted={{ rep[1] }} ({{ rep[2] }})</div>
      {% endfor %}
    </div>
    {% endif %}
  {% endif %}
</div>
{% endfor %}
</div>
<a href="{{ url_for('index') }}" class="mt-2 inline-block btn">Upload another file</a>
{% endif %}

<footer class="mt-8 text-center text-gray-400 text-sm">
PHP Vulnerability Scanner &copy; 2025
</footer>

<script>
const fileInput = document.querySelector('input[type="file"]');
const fileNameDiv = document.getElementById('selectedFileName');
const uploadLabel = document.querySelector('label[for], label:has(input[type="file"])');
const uploadForm = document.getElementById('uploadForm');

// File selection change handler
fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        fileNameDiv.textContent = "Selected file: " + fileInput.files[0].name;
    } else {
        fileNameDiv.textContent = "";
    }
});

// Drag and Drop functionality
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  uploadForm.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

// Highlight drop area when dragging over it
['dragenter', 'dragover'].forEach(eventName => {
  uploadLabel.addEventListener(eventName, () => {
    uploadLabel.style.borderColor = '#8892BE';
    uploadLabel.style.backgroundColor = 'rgba(136, 146, 190, 0.1)';
  }, false);
});

['dragleave', 'drop'].forEach(eventName => {
  uploadLabel.addEventListener(eventName, () => {
    uploadLabel.style.borderColor = '#777BB3';
    uploadLabel.style.backgroundColor = '';
  }, false);
});

// Handle dropped files
uploadLabel.addEventListener('drop', (e) => {
  const dt = e.dataTransfer;
  const files = dt.files;
  
  if (files.length > 0) {
    fileInput.files = files;
    // Trigger change event
    const event = new Event('change', { bubbles: true });
    fileInput.dispatchEvent(event);
  }
}, false);

// Jump to related code based on description
function jumpToRelatedCode(commentLineNum, commentText) {
  console.log('🚀 jumpToRelatedCode called with line:', commentLineNum, 'text:', commentText);
  
  // Find all code-line divs
  const allLines = document.querySelectorAll('.code-line');
  console.log('Found', allLines.length, 'total lines');
  
  // Extract search terms with multiple strategies
  let searchTerms = [];
  
  // Strategy 1: Direct function/keyword matching
  const directMatches = [
    'filter_var', 'mysql_real_escape_string', 'system(', 'exec(', 'shell_exec', 'passthru', 'eval(',
    '$_GET', '$_POST', '$_REQUEST', '$_COOKIE', '$_SESSION', '$_SERVER',
    'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'mysql_query', 'mysqli_query',
    'FILTER_VALIDATE_EMAIL', 'FILTER_SANITIZE', 'FILTER_VALIDATE',
    'include', 'require', 'file_get_contents', 'fopen', 'fwrite',
    'echo', 'print', 'printf', 'sprintf'
  ];
  
  for (let match of directMatches) {
    if (commentText.toLowerCase().includes(match.toLowerCase())) {
      searchTerms.push(match);
    }
  }
  
  // Strategy 2: Extract variable names (starting with $)
  const variableMatches = commentText.match(/\$\w+/g);
  if (variableMatches) {
    searchTerms.push(...variableMatches);
  }
  
  // Strategy 3: Extract quoted strings
  const quotedMatches = commentText.match(/'([^']+)'/g) || commentText.match(/"([^"]+)"/g);
  if (quotedMatches) {
    quotedMatches.forEach(match => {
      const term = match.replace(/['"]/g, '');
      if (term.length > 2) {
        searchTerms.push(term);
      }
    });
  }
  
  // Strategy 4: Special pattern matching with exact targeting
  if (commentText.includes('email_filter') || commentText.includes('email')) {
    searchTerms.push('FILTER_VALIDATE_EMAIL', 'filter_var', 'EMAIL');
  }
  if (commentText.includes('concatenation') || commentText.includes('concat')) {
    searchTerms.push('.', '+', 'concat');
  }
  if (commentText.includes('query') || commentText.includes('database')) {
    searchTerms.push('SELECT', 'INSERT', 'UPDATE', 'DELETE', 'mysql', 'mysqli');
  }
  if (commentText.includes('command') || commentText.includes('execute')) {
    searchTerms.push('system', 'exec', 'shell_exec', 'passthru');
  }
  if (commentText.includes('input') || commentText.includes('Input')) {
    searchTerms.push('$_GET', '$_POST', '$_REQUEST');
  }
  if (commentText.includes('sanitize') || commentText.includes('SANITIZE')) {
    searchTerms.push('FILTER_SANITIZE', 'filter_var');
  }
  if (commentText.includes('validate') || commentText.includes('VALIDATE')) {
    searchTerms.push('FILTER_VALIDATE', 'filter_var');
  }
  if (commentText.includes('filter') && commentText.includes('not applied')) {
    searchTerms.push('if (', 'filter_var', 'FILTER_');
  }
  if (commentText.includes('Flushes content')) {
    searchTerms.push('if (', 'else');
  }
  
  // Specific pattern for the exact case mentioned
  if (commentText.includes('Flushes content of $sanitized if the filter email_filter is not applied')) {
    searchTerms.push('if (filter_var($sanitized, FILTER_VALIDATE_EMAIL))');
  }
  
  // Strategy 5: Extract function names ending with ()
  const functionMatches = commentText.match(/\w+\(\)/g);
  if (functionMatches) {
    functionMatches.forEach(match => {
      searchTerms.push(match.replace('()', '('));
      searchTerms.push(match.replace('()', ''));
    });
  }
  
  // Strategy 6: Extract FILTER constants
  const filterMatches = commentText.match(/FILTER_\w+/gi);
  if (filterMatches) {
    searchTerms.push(...filterMatches);
  }
  
  // Remove duplicates and empty strings
  searchTerms = [...new Set(searchTerms.filter(term => term && term.length > 1))];
  
  console.log('Searching for terms:', searchTerms);
  console.log('Comment text:', commentText);
  console.log('Comment line number:', commentLineNum);
  
  // Multi-pass search with different priorities
  const searchPasses = [
    // Pass 1: Exact matches (highest priority)
    (codeText, term) => codeText.includes(term),
    // Pass 2: Case-insensitive matches
    (codeText, term) => codeText.toLowerCase().includes(term.toLowerCase()),
    // Pass 3: Partial matches for longer terms
    (codeText, term) => term.length > 4 && codeText.toLowerCase().includes(term.toLowerCase().substring(0, term.length - 1)),
    // Pass 4: Word boundary matches (for variables and functions)
    (codeText, term) => {
      if (term.startsWith('$') || term.includes('(')) {
        const regex = new RegExp('\\b' + term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
        return regex.test(codeText);
      }
      return false;
    },
    // Pass 5: Substring matches for complex terms
    (codeText, term) => {
      if (term.length > 6) {
        const parts = term.split('_');
        return parts.some(part => part.length > 3 && codeText.toLowerCase().includes(part.toLowerCase()));
      }
      return false;
    }
  ];
  
  for (let passIndex = 0; passIndex < searchPasses.length; passIndex++) {
    const searchFunction = searchPasses[passIndex];
    
    for (let line of allLines) {
      const lineId = line.id;
      const lineNum = parseInt(lineId.replace('line-', ''));
      
      if (lineNum > commentLineNum) {
        const codeSpan = line.querySelector('.code');
        if (codeSpan) {
          const codeText = codeSpan.textContent;
          
          // Debug: log what we're checking
          if (passIndex === 0) { // Only log on first pass to avoid spam
            console.log(`Checking line ${lineNum}: "${codeText.trim()}"`);
          }
          
          // Check if this line contains any of our search terms
          for (let term of searchTerms) {
            if (searchFunction(codeText, term)) {
              console.log(`✅ Found matching code at line ${lineNum} with term: "${term}" (pass ${passIndex + 1})`);
              console.log(`Code text: "${codeText.trim()}"`);
              
              // Found matching code, scroll to it and highlight
              line.scrollIntoView({ behavior: 'smooth', block: 'center' });
              
              // Highlight it
              line.style.backgroundColor = 'rgba(179, 119, 149, 0.25)';
              line.style.borderLeft = '3px solid rgba(179, 119, 149, 0.7)';
              line.style.paddingLeft = '0.3rem';
              
              // Show the reports if it has any
              const reportsDiv = line.querySelector('.reports');
              if (reportsDiv) {
                reportsDiv.style.display = 'block';
              }
              
              setTimeout(() => {
                line.style.backgroundColor = '';
                line.style.borderLeft = '';
                line.style.paddingLeft = '';
              }, 3000);
              
              return;
            }
          }
        }
      }
    }
  }
  
  // Final fallback: find the first unsafe line after the comment
  for (let line of allLines) {
    const lineId = line.id;
    const lineNum = parseInt(lineId.replace('line-', ''));
    
    if (lineNum > commentLineNum) {
      const unsafeSpan = line.querySelector('.unsafe');
      if (unsafeSpan) {
        console.log('Final fallback: Found first error at line', lineNum);
        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        line.style.backgroundColor = 'rgba(179, 119, 149, 0.25)';
        line.style.borderLeft = '3px solid rgba(179, 119, 149, 0.7)';
        line.style.paddingLeft = '0.3rem';
        
        const reportsDiv = line.querySelector('.reports');
        if (reportsDiv) {
          reportsDiv.style.display = 'block';
        }
        
        setTimeout(() => {
          line.style.backgroundColor = '';
          line.style.borderLeft = '';
          line.style.paddingLeft = '';
        }, 3000);
        
        return;
      }
    }
  }
  
  console.log('No matching code found for comment:', commentText);
}

// Toggle details AND scroll to line
function toggleDetails(clickedSpan) {
  // Find the parent code-line div
  const codeLine = clickedSpan.closest('.code-line');
  if (!codeLine) return;
  
  // Find the reports div within this code-line
  const reportsDiv = codeLine.querySelector('.reports');
  if (!reportsDiv) return;
  
  const wasHidden = reportsDiv.style.display === 'none' || reportsDiv.style.display === '';
  reportsDiv.style.display = wasHidden ? 'block' : 'none';
  
  // Scroll to the line smoothly
  if (wasHidden) {
    codeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Add temporary highlight to the entire line
    codeLine.style.backgroundColor = 'rgba(179, 119, 149, 0.25)';
    codeLine.style.borderLeft = '3px solid rgba(179, 119, 149, 0.7)';
    codeLine.style.paddingLeft = '0.3rem';
    
    setTimeout(() => {
      codeLine.style.backgroundColor = '';
      codeLine.style.borderLeft = '';
      codeLine.style.paddingLeft = '';
    }, 2000);
  }
}

// Generate mitigation suggestions for a scan
async function generateMitigation(scanId) {
  try {
    // Show loading indicator
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '⏳ Generating...';
    button.disabled = true;
    
    const response = await fetch(`/api/scan/${scanId}/mitigate`);
    const data = await response.json();
    
    if (data.success) {
      // Create a modal to display the mitigation report
      showMitigationModal(data.report, data.filename);
    } else {
      alert('Error generating mitigation suggestions: ' + data.error);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Failed to generate mitigation suggestions');
  } finally {
    // Restore button
    const button = event.target;
    button.innerHTML = originalText;
    button.disabled = false;
  }
}

// Show mitigation report in a modal
function showMitigationModal(report, filename) {
  // Create modal HTML
  const modalHTML = `
    <div id="mitigationModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div class="bg-[#0f0f10] border border-[#8892BE] rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-[#8892BE]">🔧 Security Fixes for ${filename}</h2>
            <button onclick="closeMitigationModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
          </div>
          
          <div class="mb-4 p-3 bg-[#1a1a1a] rounded border border-gray-700">
            <div class="text-sm text-gray-300">
              <strong>Summary:</strong> Found ${report.summary.total_vulnerabilities} vulnerabilities, generated ${report.summary.fixes_generated} fixes
            </div>
          </div>
          
          <div class="space-y-4">
            ${report.fixes.map((fix, index) => `
              <div class="border border-gray-700 rounded p-4">
                <h3 class="text-lg font-semibold text-yellow-400 mb-2">Fix #${index + 1}: ${fix.type}</h3>
                <div class="text-sm text-gray-400 mb-2">Line ${fix.line}</div>
                
                <div class="mb-3">
                  <h4 class="text-sm font-semibold text-red-300 mb-1">Vulnerable Code:</h4>
                  <pre class="bg-red-900 bg-opacity-20 p-3 rounded text-sm overflow-x-auto whitespace-pre-wrap break-words"><code>${fix.original}</code></pre>
                </div>
                
                <div class="mb-3">
                  <h4 class="text-sm font-semibold text-green-300 mb-1">Secure Fix:</h4>
                  <pre class="bg-green-900 bg-opacity-20 p-3 rounded text-sm overflow-x-auto whitespace-pre-wrap break-words max-h-60 overflow-y-auto"><code>${fix.fixed}</code></pre>
                </div>
                
                <div class="text-sm text-gray-300 leading-relaxed">
                  <strong>Explanation:</strong> 
                  <div class="mt-2 p-3 bg-gray-800 bg-opacity-50 rounded border-l-4 border-blue-400">
                    ${fix.explanation}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div class="mt-6 text-center">
            <button onclick="copyMitigationReport()" class="bg-[#8892BE] text-black px-4 py-2 rounded hover:bg-[#777BB3] transition-colors mr-2">
              📋 Copy Report
            </button>
            <button onclick="closeMitigationModal()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Store report data for copying
  window.currentMitigationReport = report;
}

// Close mitigation modal
function closeMitigationModal() {
  const modal = document.getElementById('mitigationModal');
  if (modal) {
    modal.remove();
  }
}

// Copy mitigation report to clipboard
function copyMitigationReport() {
  if (window.currentMitigationReport) {
    navigator.clipboard.writeText(window.currentMitigationReport.report_text)
      .then(() => {
        alert('Mitigation report copied to clipboard!');
      })
      .catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy report to clipboard');
      });
  }
}

const tabs = document.querySelectorAll('.tab-btn');
const contents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    // Remove active styles from all tabs
    tabs.forEach(t => t.classList.remove('active', 'font-bold', 'text-[#8892BE]'));
    tabs.forEach(t => t.classList.add('text-gray-400'));

    // Hide all tab contents
    contents.forEach(c => c.classList.add('hidden'));

    // Show selected tab content
    const target = document.getElementById(tab.dataset.tab);
    target.classList.remove('hidden');

    // Highlight active tab
    tab.classList.add('active', 'font-bold', 'text-[#8892BE]');
    tab.classList.remove('text-gray-400');
  });
});


tabs.forEach(tab => tab.classList.remove('active'));
tab.classList.add('active');
</script>


</body>
</html>
