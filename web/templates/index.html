<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PHP Vulnerability Scanner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #000; color: white; font-family: monospace; margin:0; padding:0; }

/* Upload box */
@keyframes pulse-glow {
  0%,100% { box-shadow:0 0 8px 2px rgba(119,123,179,0.14); }
  50% { box-shadow:0 0 12px 3px rgba(136,146,190,0.18); }
}
.hover-pulse:hover { animation:pulse-glow 4s infinite; }

.btn { background-color: #8892BE; color: black; padding:0.5rem 1rem; border-radius:0.25rem; cursor:pointer; transition: all 0.2s; }
.btn:hover { background-color:#777BB3; transform: translateY(-1px); }
input[type="file"] { display:none; }

/* Results container */
#resultsContent {
  max-height: 500px;
  overflow-y: auto;
  background-color: #0f0f10;
  padding:0.5rem 1rem;
  border-radius:0.5rem;
  font-family: monospace;
  margin-top:1rem;
  font-size:0.85rem;
  line-height: 1.2rem;
}

/* Code line container */
.code-line {
  display: block;
  margin: 0;
  padding: 0;
}

.code-line:hover {
  background-color: rgba(136,146,190,0.05);
}

/* Line number and code */
.line-number { 
  color:#666; 
  width:3ch; 
  display:inline-block; 
  text-align:right; 
  user-select:none;
  margin-right: 0.5rem;
}
.code { 
  display:inline; 
  white-space: pre;
}
.safe { color:#8892BE; }
.unsafe { color:#b37795; cursor:pointer; }
.unsafe:hover { background-color: rgba(179, 119, 149, 0.2); }

/* Reports - display on new line */
.reports { 
  font-size:0.7rem; 
  color:#f4c542; 
  display:none; 
  margin-left:4ch;
  padding: 0.15rem 0 0.15rem 0.5rem;
  line-height:1.1rem;
  background-color: rgba(244, 197, 66, 0.05);
  border-left: 2px solid rgba(244, 197, 66, 0.3);
}
.report { 
  display: block;
  margin: 0;
  padding: 0;
}
.cursor-pointer { cursor:pointer; }

.tab-btn.active {
  background-color: rgba(136,146,190,0.15);
  border-radius: 0.25rem;
}

</style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-6">

<h1 class="text-3xl font-bold mb-4 text-[#8892BE] text-center">PHP Vulnerability Scanner</h1>
<!-- NAVIGATION PANEL -->
<div class="w-full max-w-2xl mb-4">
  <div class="flex border-b border-gray-700">
    <button class="tab-btn font-bold text-[#8892BE] px-4 py-2" data-tab="uploadTab">Upload</button>
    <button class="tab-btn text-gray-400 px-4 py-2" data-tab="historyTab">Past Scans</button>
    <a href="/database" class="tab-btn text-gray-400 px-4 py-2 hover:text-[#8892BE]">Database</a>
  </div>

 
  <div id="uploadTab" class="tab-content">
     
  </div>
    <div id="historyTab" class="tab-content hidden">
      {% if past_scans %}
        <div class="space-y-2">
          {% for scan in past_scans %}
            <div class="bg-[#0f0f10] p-3 rounded border border-gray-700 hover:border-[#8892BE] transition-colors">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <a href="{{ url_for('view_scan', scan_id=scan.id) }}" class="text-[#8892BE] hover:underline font-medium">
                    {{ scan.filename }}
                  </a>
                  <div class="text-sm text-gray-400 mt-1">
                    {{ scan.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    {% if scan.total_lines > 0 %}
                      {% set rate = (scan.unsafe_lines / scan.total_lines * 100) %}
                      {{ scan.total_lines }} lines | {{ scan.unsafe_lines }} unsafe | 
                      <span class="{% if rate > 50 %}text-red-400{% elif rate > 20 %}text-yellow-400{% else %}text-green-400{% endif %}">
                        {{ "%.1f"|format(rate) }}% vulnerability rate
                      </span>
                    {% endif %}
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  {{ "%.1f"|format(scan.file_size / 1024) }} KB
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-gray-400 mt-2">No past scans yet.</p>
      {% endif %}
    </div>
</div>

<form id="uploadForm" method="post" enctype="multipart/form-data" class="w-full max-w-2xl">
  <label class="relative w-full h-64 border-4 border-dashed border-[#777BB3] rounded-xl flex items-center justify-center cursor-pointer hover:border-[#8892BE] hover:bg-[#0f0f10] hover-pulse">
    <input type="file" name="file" accept=".php" required>
    <div class="flex flex-col items-center justify-center pointer-events-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-[#777BB3] mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v8m0 0l-4-4m4 4l4-4M12 4v8"/>
      </svg>
      <div class="text-center pointer-events-none">
        <div class="text-[#8892BE] text-lg mb-3">Drag a PHP file here</div>
        <div class="pointer-events-auto">
          <button type="button" onclick="this.closest('label').querySelector('input').click()" class="btn">Browse</button>
        </div>
      </div>
    </div>
  </label>
  <div class="mt-4">
    <button type="submit" class="w-full btn">Scan</button>
  </div>
  <div id="selectedFileName" class="mt-2 text-[#8892BE] text-center"></div>
</form>

{% if results %}
<h2 class="text-2xl font-bold mt-6 mb-2 text-[#8892BE]">Scan Results for {{ filename }}</h2>
<div id="resultsContent">
{% for r in results %}
<div class="code-line" id="line-{{ r.line_num }}">
  <span class="cursor-pointer {{ r.label }}" onclick="toggleDetails(this)" data-line="{{ r.line_num }}">
    <span class="line-number">{{ r.line_num }}</span>
    <span class="code {{ r.label }}">{{ r.line }}</span>
  </span>
  {% if r.reports %}
  <div class="reports">
    {% for rep in r.reports %}
    <div class="report">ðŸ”¸ <strong>{{ rep[0] }}</strong> - tainted={{ rep[1] }} ({{ rep[2] }})</div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endfor %}
</div>
<a href="{{ url_for('index') }}" class="mt-2 inline-block btn">Upload another file</a>
{% endif %}

<footer class="mt-8 text-center text-gray-400 text-sm">
PHP Vulnerability Scanner &copy; 2025
</footer>

<script>
const fileInput = document.querySelector('input[type="file"]');
const fileNameDiv = document.getElementById('selectedFileName');
const uploadLabel = document.querySelector('label[for], label:has(input[type="file"])');
const uploadForm = document.getElementById('uploadForm');

// File selection change handler
fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        fileNameDiv.textContent = "Selected file: " + fileInput.files[0].name;
    } else {
        fileNameDiv.textContent = "";
    }
});

// Drag and Drop functionality
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  uploadForm.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

// Highlight drop area when dragging over it
['dragenter', 'dragover'].forEach(eventName => {
  uploadLabel.addEventListener(eventName, () => {
    uploadLabel.style.borderColor = '#8892BE';
    uploadLabel.style.backgroundColor = 'rgba(136, 146, 190, 0.1)';
  }, false);
});

['dragleave', 'drop'].forEach(eventName => {
  uploadLabel.addEventListener(eventName, () => {
    uploadLabel.style.borderColor = '#777BB3';
    uploadLabel.style.backgroundColor = '';
  }, false);
});

// Handle dropped files
uploadLabel.addEventListener('drop', (e) => {
  const dt = e.dataTransfer;
  const files = dt.files;
  
  if (files.length > 0) {
    fileInput.files = files;
    // Trigger change event
    const event = new Event('change', { bubbles: true });
    fileInput.dispatchEvent(event);
  }
}, false);

// Toggle details AND scroll to line
function toggleDetails(clickedSpan) {
  // Find the parent code-line div
  const codeLine = clickedSpan.closest('.code-line');
  if (!codeLine) return;
  
  // Find the reports div within this code-line
  const reportsDiv = codeLine.querySelector('.reports');
  if (!reportsDiv) return;
  
  const wasHidden = reportsDiv.style.display === 'none' || reportsDiv.style.display === '';
  reportsDiv.style.display = wasHidden ? 'block' : 'none';
  
  // Scroll to the line smoothly
  if (wasHidden) {
    codeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Add temporary highlight to the entire line
    codeLine.style.backgroundColor = 'rgba(179, 119, 149, 0.25)';
    codeLine.style.borderLeft = '3px solid rgba(179, 119, 149, 0.7)';
    codeLine.style.paddingLeft = '0.3rem';
    
    setTimeout(() => {
      codeLine.style.backgroundColor = '';
      codeLine.style.borderLeft = '';
      codeLine.style.paddingLeft = '';
    }, 2000);
  }
}

const tabs = document.querySelectorAll('.tab-btn');
const contents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    // Remove active styles from all tabs
    tabs.forEach(t => t.classList.remove('active', 'font-bold', 'text-[#8892BE]'));
    tabs.forEach(t => t.classList.add('text-gray-400'));

    // Hide all tab contents
    contents.forEach(c => c.classList.add('hidden'));

    // Show selected tab content
    const target = document.getElementById(tab.dataset.tab);
    target.classList.remove('hidden');

    // Highlight active tab
    tab.classList.add('active', 'font-bold', 'text-[#8892BE]');
    tab.classList.remove('text-gray-400');
  });
});


tabs.forEach(tab => tab.classList.remove('active'));
tab.classList.add('active');
</script>


</body>
</html>
